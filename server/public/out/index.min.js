Globe=function(b){var m,u,x,f,F,y;function G(c){F=-c.clientX;y=c.clientY;c=v/1E3;x=B.x+0.005*(F-C.x)*c;f=B.y+0.005*(y-C.y)*c;f=f>D?D:f;f=f<-D?-D:f}function H(){b.removeEventListener("mousemove",G,!1);b.removeEventListener("mouseup",H,!1);b.removeEventListener("mouseout",I,!1);b.style.cursor="auto"}function I(){b.removeEventListener("mousemove",G,!1);b.removeEventListener("mouseup",H,!1);b.removeEventListener("mouseout",I,!1)}function E(c){w-=c;w=1200<w?1200:w;w=350>w?350:w}function O(){x+=0.002*(v/
1E3);E(R);m+=0.1*(x-m);u+=0.1*(f-u);v+=0.3*(w-v);p.position.x=v*Math.sin(m)*Math.cos(u);p.position.y=v*Math.sin(u);p.position.z=v*Math.cos(m)*Math.cos(u);p.lookAt(e.position);J++;if(4==J){for(var c=0;c<h.length;c++){var b=h[c].scale.z;h[c].ztarget?b>h[c].ztarget+2?h[c].scale.z=b+0.55*(h[c].ztarget-b):(h[c].scale.z=h[c].ztarget,delete h[c].ztarget):-1>b?h[c].scale.z=b+0.5:h[c].linger?(h[c].linger+=0.5,100<h[c].linger&&(b=h[c],z.remove(b),delete b,h.splice(c,1))):h[c].linger=0.1}J=0}t.clear();t.render(z,
p);t.render(K,p);requestAnimationFrame(O)}var P={earth:{uniforms:{texture:{type:"t",value:0,texture:null}},vertexShader:"varying vec3 vNormal;\nvarying vec2 vUv;\nvoid main() {\ngl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\nvNormal = normalize( normalMatrix * normal );\nvUv = uv;\n}",fragmentShader:"uniform sampler2D texture;\nvarying vec3 vNormal;\nvarying vec2 vUv;\nvoid main() {\nvec3 diffuse = texture2D( texture, vUv ).xyz;\nfloat intensity = 1.05 - dot( vNormal, vec3( 0.0, 0.0, 1.0 ) );\nvec3 atmosphere = vec3( 1.0, 1.0, 1.0 ) * pow( intensity, 4.0 );\ngl_FragColor = vec4( diffuse + atmosphere, 1.0 );\n}"},
atmosphere:{uniforms:{},vertexShader:"varying vec3 vNormal;\nvoid main() {\nvNormal = normalize( normalMatrix * normal );\ngl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",fragmentShader:"varying vec3 vNormal;\nvoid main() {\nfloat intensity = pow( 0.8 - dot( vNormal, vec3( 0, 0, 1.0 ) ), 12.0 );\ngl_FragColor = vec4( 0.55, 1.0, 1.0, 1.0 ) * intensity;\n}"}},p,z,K,t,L,M,e,h=[],N,R=0;y=F=0;var C={x:0,y:0};u=m=0;x=3*Math.PI/2;f=Math.PI/12;var B={x:0,y:0},v=1E5,w=1E5,D=Math.PI/
2,J=0;b.style.color="#fff";b.style.font="13px/20px Arial, sans-serif";var n,A;L=b.offsetWidth||window.innerWidth;M=b.offsetHeight||window.innerHeight;p=new THREE.PerspectiveCamera(30,L/M,1,2E4);p.position.z=v;z=new THREE.Scene;K=new THREE.Scene;var Q=new THREE.SphereGeometry(200,40,30);n=P.earth;A=THREE.UniformsUtils.clone(n.uniforms);A.texture.texture=THREE.ImageUtils.loadTexture("/earth_atmos_2048.jpg");n=new THREE.ShaderMaterial({uniforms:A,vertexShader:n.vertexShader,fragmentShader:n.fragmentShader});
e=new THREE.Mesh(Q,n);e.matrixAutoUpdate=!1;z.add(e);n=P.atmosphere;A=THREE.UniformsUtils.clone(n.uniforms);n=new THREE.ShaderMaterial({uniforms:A,vertexShader:n.vertexShader,fragmentShader:n.fragmentShader});e=new THREE.Mesh(Q,n);e.scale.x=e.scale.y=e.scale.z=1.1;e.flipSided=!0;e.matrixAutoUpdate=!1;e.updateMatrix();K.add(e);t=new THREE.WebGLRenderer({antialias:!0});t.autoClear=!1;t.setClearColorHex(0,0);t.setSize(L,M);t.domElement.style.position="absolute";b.appendChild(t.domElement);b.addEventListener("mousedown",
function(c){c.preventDefault();b.addEventListener("mousemove",G,!1);b.addEventListener("mouseup",H,!1);b.addEventListener("mouseout",I,!1);C.x=-c.clientX;C.y=c.clientY;B.x=x;B.y=f;b.style.cursor="move"},!1);b.addEventListener("mousewheel",function(c){c.preventDefault();N&&E(0.3*c.wheelDeltaY);return!1},!1);document.addEventListener("keydown",function(c){switch(c.keyCode){case 38:E(100);c.preventDefault();break;case 40:E(-100),c.preventDefault()}},!1);window.addEventListener("resize",function(){p.aspect=
window.innerWidth/window.innerHeight;p.updateProjectionMatrix();t.setSize(window.innerWidth,window.innerHeight)},!1);b.addEventListener("mouseover",function(){N=!0},!1);b.addEventListener("mouseout",function(){N=!1},!1);this.animate=O;this.addPoint=function(c,b,x,f){for(var c=(90-c)*Math.PI/180,b=(180-b)*Math.PI/180,k=new THREE.CubeGeometry(0.75,0.75,1,1,1,1,null,!1,{px:!0,nx:!0,py:!0,ny:!0,pz:!1,nz:!0}),e=0;e<k.vertices.length;e++);k=new THREE.Mesh(k,new THREE.MeshBasicMaterial({color:16777215,vertexColors:THREE.FaceColors,
morphTargets:!1}));k.position.x=200*Math.sin(c)*Math.cos(b);k.position.y=200*Math.cos(c);k.position.z=200*Math.sin(c)*Math.sin(b);k.lookAt(z.position);k.scale.z=-1;k.ztarget=-x;k.updateMatrix();for(e=0;e<k.geometry.faces.length;e++)k.geometry.faces[e].color=f;z.add(k);h.push(k)};return this};
(function(){if(Detector.webgl){var b=document.getElementById("container"),m=new Globe(b),b=io.connect(window.location.href);b.on("latlng",function(b){$(".conStat").html("connected");$(".twitRate").html(b.rate+"/s");var f=new THREE.Color;f.setHSV(0.55,1,1);m.addPoint(b.lat,b.lng,b.size,f)});b.on("stats",function(b){$(".totTwit").html(b.count);$(".coordTwits").html(b.withGeo);for(var f=[],m=b.countryCount.length-1;0<=m;m--){var y=b.countryCount[m];f.push({name:y.name,count:y.count})}b=Mustache.to_html(u.templates.countries,
{countryCount:f});$(".countryList").html(b)});m.animate()}else Detector.addGetWebGLMessage();var u={templates:{countries:"<br />Total Twits By Country:<br /><ul class='countryList'>{{#countryCount}}<li><b>{{name}}</b> : {{count}}</li>{{/countryCount}}</ul>"}}})(document);
